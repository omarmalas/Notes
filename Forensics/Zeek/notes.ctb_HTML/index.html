<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>notes.ctb</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
  <script src="res/script3.js"></script>
</head>
<body>
<div class='page'><h1 class='title level-1'>Zeek</h1><br/><p>-Each log output consists of multiple fields, and each field holds a different part of the traffic data. Correlation is done through a unique value called &quot;UID&quot;. The &quot;UID&quot; represents the unique identifier assigned to each session.</p><p></p><p></p><p></p><p></p><p></p><p></p><p><img src="images/1-1.png" alt="images/1-1.png" /></p><p></p><p></p><p><a href="https://docs.zeek.org/en/current/script-reference/log-files.html"><img src="images/1-2.png" alt="images/1-2.png" /></a></p><p></p><p><img src="images/1-3.png" alt="images/1-3.png" /></p><p></p><p></p></div><div class='page'><h1 class='title level-2'>Zeek Scripts</h1><br/><p><h3>Zeek has its own event-driven scripting language, which is as powerful as high-level languages and allows us to investigate and correlate the detected events. Since it is as capable as high-level programming languages, you will need to spend time on Zeek scripting language in order to become proficient. In this room, we will cover the basics of Zeek scripting to help you understand, modify and create basic scripts. Note that scripts can be used to apply a policy and in this case, they are called policy scripts.</h3></p><p></p><p><img src="images/2-1.png" alt="images/2-1.png" /></p><p></p><p></p><p><h3>Scripts contain operators, types, attributes, declarations and statements, and directives. Let&#39;s look at a simple example event called &quot;zeek_init&quot; and &quot;zeek_done&quot;. These events work once the Zeek process starts and stops. Note that these events don&#39;t have parameters, and some events will require parameters.</h3></p><p></p><p><img src="images/2-2.png" alt="images/2-2.png" /></p><p></p><p>Let&#39;s print the packet data to the terminal and see the raw data. In this script, we are requesting details of a connection and extracting them without any filtering or sorting of the data. To accomplish this, we are using the &quot;new_connection&quot; event. This event is automatically generated for each new connection. This script provides bulk information on the terminal. We need to get familiar with Zeek&#39;s data structure to reduce the amount of information and focus on the event of interest. To do so, we need to investigate the bulk data.</p><p></p><p><img src="images/2-3.png" alt="images/2-3.png" /></p><p></p><p></p><p><img src="images/2-4.png" alt="images/2-4.png" /></p><p></p><p>The above terminal provides bulk data for each connection. This style is not the best usage, and in real life, we will need to filter the information for specific purposes. If you look closely at the output, you can see an ID and field value for each part. To filter the event of interest, we will use the primary tag (in this case, it is c --comes from &quot;c: connection&quot;--), id value (id=), and field name. You should notice that the fields are the same as the fields in the log files.</p><p></p><p><img src="images/2-5.png" alt="images/2-5.png" /></p><p></p><p><img src="images/2-6.png" alt="images/2-6.png" /></p><p></p><p>The above output shows that we successfully extract specific information from the events. Remember that this script extracts the event of interest (in this example, a new connection), and we still have logs in the working directory. We can always modify and optimise the scripts at any time.</p><p></p><p></p><p><strong><h2>Scripts 201 | Use Scripts and Signatures Together</h2></strong><h3></h3></p><p><h3></h3></p><p><h3>Up to here, we covered the basics of Zeek scripts. </h3><small>Now it is time to use scripts collaboratively with other scripts and signatures to get one step closer to event correlation. Zeek scripts can refer to signatures and other Zeek scripts as well. This flexibility provides a massive advantage in event correlation.</small></p><p><h3>Let&#39;s demonstrate this concept with an example. We will create a script that detects if our previously created &quot;</h3><strong><h3>ftp-admin</h3></strong><h3>&quot; rule has a hit. </h3></p><p></p><p><a href="https://docs.zeek.org/en/master/scripts/base/bif/event.bif.zeek.html?highlight=signature_match"><img src="images/2-7.png" alt="images/2-7.png" /></a></p><p></p><p><small>This basic script quickly checks if there is a signature hit and provides terminal output to notify us. We are using the &quot;signature_match&quot; event to accomplish this. You can read more about events </small><a href="https://docs.zeek.org/en/master/scripts/base/bif/event.bif.zeek.html?highlight=signature_match">here</a><small>. Note that we are looking only for &quot;ftp-admin&quot; signature hits. The signature is shown below. </small></p><p></p><p><img src="images/2-8.png" alt="images/2-8.png" /></p><p></p><p><img src="images/2-9.png" alt="images/2-9.png" /></p><p></p><p><h3>The above output shows that we successfully combined the signature and script. Zeek processed the signature and logs then the script controlled the outputs and provided a terminal output for each rule hit.</h3></p><p></p><p></p><p></p><p><strong><h2>Scripts 202 | Load Local Scripts</h2></strong><h3></h3></p><p><h3></h3></p><p><strong><h3>Load all local scripts</h3></strong></p><p><h3>We mentioned that Zeek has base scripts located in </h3><small>&quot;/opt/zeek/share/zeek/base</small><small>&quot;. You can load all local scripts identified in your &quot;local.zeek&quot; file. Note that base scripts cover multiple framework functionalities. You can load all base scripts by easily running the </small><code><h3>local</h3></code><small> command.</small></p><p></p><p></p><p><img src="images/2-10.png" alt="images/2-10.png" /></p><p></p><p><h3>The above output demonstrates how to run all base scripts using the &quot;local&quot; command. Look at the above terminal output; Zeek provided additional log files this time. Loaded scripts generated loaded_scripts.log, capture_loss.log, notice.log, stats.log files. Note that, in our instance, 465 scripts loaded and used by using the &quot;local&quot; command. However, Zeek doesn&#39;t provide log files for the scripts doesn&#39;t have hits or results.</h3></p><p></p><p><img src="images/2-11.png" alt="images/2-11.png" /></p><p></p><p><h3>The above output shows how to load a specific script. This script provides much more information than the one we created. It provides one single line output and a connection summary for the suspicious incident. You can find and read more on the prebuilt scripts and frameworks by visiting Zeek&#39;s online book </h3><a href="https://docs.zeek.org/en/master/frameworks/index.html">here</a><h3>.</h3></p><p></p><p></p></div><div class='page'><h1 class='title level-2'>Zeek Signatures</h1><br/><p></p><p>Signatures:</p><p></p><p>Signatures need to run when zeek starts in order for zeek to look for a signature. </p><p></p><p><img src="images/3-1.png" alt="images/3-1.png" /></p><p></p><p>Sample Singature: </p><p><img src="images/3-2.png" alt="images/3-2.png" /></p><p></p></div><div class='page'><h1 class='title level-2'>Zeek FrameWorks</h1><br/><p>W<h3>e mentioned that Zeek highly relies on scripts, and the frameworks depend on scripts. Let&#39;s have a closer look at the file hash framework and see the script behind it.</h3></p><p></p><p><h3>You can read more on the intelligence framework </h3><a href="https://docs.zeek.org/en/master/frameworks/intel.html">here</a><h3> and </h3><a href="https://docs.zeek.org/en/current/scripts/base/frameworks/intel/main.zeek.html#type-Intel::Type">here</a><h3>.</h3></p><p></p><p></p><p><strong><h2>Scripts 203 | Load Frameworks</h2></strong><h3></h3></p><p><h3></h3></p><p><h3>Zeek has 15+ frameworks that help analysts to discover the different events of interest. In this task, we will cover the common frameworks and functions. </h3><small>You can find and read more on the prebuilt scripts and frameworks by visiting Zeek&#39;s online book </small><h3>here</h3><h3>.</h3></p><p><strong><h3>File Framework | Hashes</h3></strong></p><p><h3>Not all framework functionalities are intended to be used in CLI mode. The majority of them are used in scripting. You can easily see the usage of frameworks in scripts by calling a specific framework as </h3><code><h3>load @ $PATH/base/frameworks/framework-name</h3></code><h3>. Now, let&#39;s use a prebuilt function of the file framework and have MD5, SHA1 and SHA256 hashes of the detected files. We will call the &quot;File Analysis&quot; framework&#39;s &quot;hash-all-files&quot; script to accomplish this. Before loading the scripts, let&#39;s look at how it works.</h3></p><p></p><p></p><p><img src="images/5-1.png" alt="images/5-1.png" /></p><p></p><p><h3>The above output shows how frameworks are loaded. In earlier tasks, we mentioned that Zeek highly relies on scripts, and the frameworks depend on scripts. Let&#39;s have a closer look at the file hash framework and see the script behind it.</h3></p><p></p><p></p><p><img src="images/5-2.png" alt="images/5-2.png" /></p><p></p><p><h3>Now let&#39;s execute the script and investigate the log file.</h3></p><p></p><p><img src="images/5-3.png" alt="images/5-3.png" /></p><p></p><p>Look at the above terminal outputs. Both of the scripts provided the same result. Here the preference is up to the user. Both of the usage formats are true. Prebuilt frameworks are commonly used in scriptings with the &quot;@load&quot; method. Specific scripts are used as practical scripts for particular use cases.</p><p></p><p></p><p></p><p><strong><h3>File Framework | Extract Files</h3></strong><small></small></p><p><small></small></p><p><h3>The file framework can extract the files transferred. Let&#39;s see this feature in action!</h3></p><p><img src="images/5-4.png" alt="images/5-4.png" /></p><p></p><p><h3>We successfully extracted files from the pcap. A new folder called &quot;extract_files&quot; is automatically created, and all detected files are located in it. First, we will list the contents of the folder, and then we will use the </h3><code>file</code><h3> command to determine the file type of the extracted files.</h3></p><p></p><p><img src="images/5-5.png" alt="images/5-5.png" /></p><p></p><p><h3>Zeek extracted three files. The &quot;file&quot; command shows us one .txt file, one .doc/.docx file and one .exe file. Zeek renames extracted files. The name format consists of four values that come from conn.log and files.log files; default &quot;extract&quot; keyword, timestamp value (ts), protocol (source), and connection id (conn_uids). Let&#39;s look at the files.log to understand possible anomalies better and verify the findings. Look at the below output; files.log provides the same results with additional details. Let&#39;s focus on the .exe and correlate this finding by searching its connection id (conn_uids).</h3></p><p><h3>The given terminal output shows us that there are three files extracted from the traffic capture. Let&#39;s look at the file.log and correlate the findings with the rest of the log files. </h3></p><p></p><p></p><p><img src="images/5-6.png" alt="images/5-6.png" /></p><p></p><p><h3>The &quot;grep&quot; tool helps us investigate the particular value across all available logs. The above terminal output shows us that the connection id linked with .exe appears in conn.log, files.log, and http.log files. Given example demonstrates how to filter some fields and correlate the findings with the rest of the logs. We&#39;ve listed the source and destination addresses, file and connection id numbers, </h3>MIME<h3> types, and file names. Up to now, provided outputs and findings show us that record number three is a .exe file, and other log files provide additional information. </h3></p><p></p><p></p><p></p><p><strong><h3>Notice Framework | Intelligence</h3></strong><small></small></p><p><small></small></p><p><h3>The intelligence framework can work with data feeds to process and correlate events and identify anomalies. The intelligence framework requires a feed to match and create alerts from the network traffic. Let&#39;s demonstrate a single user-generated threat intel file and let Zeek use it as the primary intelligence source. </h3></p><p><h3>Intelligence source location: </h3><code><h3>/opt/zeek/intel/zeek_intel.txt</h3></code></p><p><h3>There are two critical points you should never forget. First, the source file has to be tab-delimited. Second, you can manually update the source and adding extra lines doesn&#39;t require any re-deployment. However, if you delete a line from the file, you will need to re-deploy the Zeek instance. </h3></p><p><h3>Let&#39;s add the suspicious URL gathered from the case1.pcap file as a source intel and see this feature in action! Before executing the script, let&#39;s look at the intelligence file and the script contents.</h3></p><p></p><p></p><p><img src="images/5-7.png" alt="images/5-7.png" /></p><p></p><p></p><p><h3>The above output shows the contents of the intel file and script contents. There is one intelligence input, and it is focused on a domain name, so when this domain name appears in the network traffic, Zeek will create the &quot;intel.log&quot; file and provide the available details.</h3></p><p></p><p><img src="images/5-8.png" alt="images/5-8.png" /></p><p></p><p><h3>The above output shows that Zeek detected the listed domain and created the intel.log file. This is one of the easiest ways of using the intelligence framework.</h3></p></div><div class='page'><h1 class='title level-2'>Zeek Packacges</h1><br/><p><strong><h2>Scripts 204 | Package Manager</h2></strong><h3></h3></p><p><h3></h3></p><p><h3>Zeek Package Manager helps users install third-party scripts and plugins to extend Zeek functionalities with ease. The package manager is installed with Zeek and available with the </h3><code><h3>zkg</h3></code><h3> command. Users can install, load, remove, update and create packages with the &quot;zkg&quot; tool. You can read more on and view available packages </h3><h3>here</h3><h3> and </h3><h3>here</h3><h3>. Please note that you need root privileges to use the &quot;zkg&quot; tool.</h3></p><p></p><p></p><p><img src="images/6-1.png" alt="images/6-1.png" /></p><p></p><p></p><p><h3>There are multiple ways of using packages. The first approach is using them as frameworks and calling specific package path/directory per usage. The second and most common approach is calling packages from a script with the &quot;@load&quot; method. The third and final approach to using packages is calling their package names; note that this method works only for packages installed with the &quot;zkg&quot; install method. </h3></p><p></p><p></p><p></p><p><strong><h3>Packages | </h3></strong><strong><h3>Cleartext Submission of Password</h3></strong><h3></h3></p><p><h3></h3></p><p><h3>Let&#39;s install a package first and then demonstrate the usage in different approaches. </h3></p><p><h3></h3><strong><h3>Note: </h3></strong><h3>The package is installed in the given VM.</h3></p><p></p><p><img src="images/6-2.png" alt="images/6-2.png" /></p><p></p><p><h3>The above output shows how to install and list the installed packages. Now we successfully installed a package. As the description mentions on the above terminal, this package creates alerts for cleartext passwords found in </h3>HTTP<h3> traffic. Let&#39;s use this package in three different ways!</h3></p><p></p><p><img src="images/6-3.png" alt="images/6-3.png" /></p><p></p><p><h3>The above output demonstrates how to execute/load packages against a pcap. You can use the best one for your case. The &quot;zeek-sniffpass&quot; package provides additional information in the notice.log file. Now let&#39;s review the logs and discover the obtained data using the specific package.</h3></p><p></p><p><img src="images/6-4.png" alt="images/6-4.png" /></p><p></p><p><h3>The above output shows that the package found cleartext password submissions, provided notice, and grabbed the usernames. Remember, in </h3><strong>TASK-5</strong><h3> we created a signature to do the same action. Now we can do the same activity without using a signature file. This is a simple demonstration of the benefit and flexibility of the Zeek scripts.</h3></p><p></p><p></p><p></p><p><strong><h3>Packages | </h3></strong><strong><h3>Geolocation Data</h3></strong><h3></h3></p><p><h3></h3></p><p><h3>Let&#39;s use another helpful package called &quot;geoip-conn&quot;. This package provides geolocation information for the IP addresses in the conn.log file. It depends on &quot;GeoLite2-City.mmdb&quot; database created by MaxMind. This package provides location information for only matched IP addresses from the internal database.</h3></p><p></p><p><img src="images/6-5.png" alt="images/6-5.png" /></p><p></p><p><h3>Up to now, we&#39;ve covered what the Zeek packages are and how to use them. There are much more packages and scripts available for Zeek in the wild. You can try ready or third party packages and scripts or learn Zeek scripting language and create new ones.</h3></p><p></p></div>
</body>
</html>
